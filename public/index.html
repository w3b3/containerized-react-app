<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-7342EX4ZK2"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-7342EX4ZK2");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- add title -->
    <title>ğŸ Willis-Brown</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="app/style.css" type="text/css" />
  </head>
  <body>
    <div class="bottom">
      <header>
        <a href="/">Home</a>
        <a href="/contact">Contact us</a>
        <a href="https://blog.codein.ca">Blog</a>
        <a href="https://api.codein.ca/auth/google">Register</a>
        <!-- <a href="/testimonials">Testimonials</a> -->

        <img class="logo" src="app/logo.png" alt="" />
      </header>
      <button onclick="fetchNextPage" id="load-more" type="button">More</button>
      <article id="posts" class="posts">
        <!-- <section class="card">
          <span class="icon">ğŸ’•</span>

          <h1>Breaking news from the world of CSS!</h1>
          <div class="body">
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Enim
            dolorem commodi cumque assumenda necessitatibus, exercitationem
            deserunt consequuntur nemo dicta at et aperiam voluptas pariatur
            ipsa quas reiciendis tempora aspernatur. Nulla!
          </div>
        </section> -->
      </article>
    </div>
    <script>
      let nextPageToken = "";

      function fetchSubscriptions(pageToken) {
        const authToken = sessionStorage.getItem("authToken");

        if (!authToken) {
          console.error("No auth token found");
          return;
        }
        
        let url = `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet,contentDetails&mine=true&maxResults=50`;
        
        if (pageToken) {
          url += `&pageToken=${pageToken}`;
        }

        fetch(url, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${authToken}`,
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            displaySubscriptions(data.items);
            nextPageToken = data.nextPageToken || "";
          })
          .catch((error) => {
            console.error("Error fetching subscriptions:", error);
          });
      }

      // Call this function to fetch the next set of results
      function fetchNextPage() {
        if (nextPageToken) {
          fetchSubscriptions(nextPageToken);
        } else {
          console.log("No more pages to fetch");
        }
      }

      function displaySubscriptions(subscriptions) {
        const list = document.getElementById("posts");
        list.innerHTML = ""; // Clear existing list

        subscriptions.forEach((sub) => {
          const listItem = document.createElement("section");
          //listItem.textContent = sub.snippet.title;
          listItem.className = "card";
          listItem.innerHTML = `
                    <span class="icon">ğŸ’•</span>
                    <h1 class='title'>foo</h1>
                    <a class="link">Go to the channel</a>
                `;
          // move the textContent above to inside the element with class = title
          const titleElement = listItem.querySelector("h1.title");
          titleElement.textContent = sub.snippet.title;
          const imageElement = createElement("img");
          imageElement.src = sub.snippet.thumbnails.default.url;
          imageElement.alt = sub.snippet.title;
          imageElement.width = 100;
          imageElement.height = 100;
          imageElement.className = "thumbnail";
          titleElement.appendChild(imageElement);
          const linkElement = listItem.querySelector("a.link");
          linkElement.textContent = `https://youtube.com/channel/${sub.snippet.resourceId.channelId}`;
          // show the span.icon only if contentDetails.totalItemCount is greater than 3000
          const iconElement = listItem.querySelector("span.icon");
          iconElement.style.display =
            sub.contentDetails.totalItemCount >= 10000 ? "unset" : "none";
          list.appendChild(listItem);
        });
      }

      fetchSubscriptions();
    </script>
  </body>
</html>
